name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # VALIDATION - Must pass before any deployment
  # ============================================
  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Build Next.js
        run: npm run build
        env:
          NEXT_PUBLIC_GIT_SHA: ${{ github.sha }}
          NEXT_PUBLIC_BUILD_TIME: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}

      - name: Build OpenNext for Cloudflare
        run: npx opennextjs-cloudflare build
        env:
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}

      - name: Verify build output
        run: |
          echo "Checking .open-next directory..."
          ls -la .open-next/
          echo "Checking worker.js..."
          ls -la .open-next/worker.js
          echo "Checking assets..."
          ls -la .open-next/assets/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opennext-build
          path: .open-next/
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

  # ============================================
  # PREVIEW DEPLOYMENT - For Pull Requests
  # ============================================
  deploy-preview:
    name: Deploy Preview
    needs: validate
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: opennext-build
          path: .open-next/

      - name: Deploy Preview to Cloudflare
        id: deploy
        run: npx wrangler deploy --env preview 2>&1 || npx opennextjs-cloudflare deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Comment Preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.deployment-url }}';
            const sha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);

            const body = `### ðŸš€ Preview Deployment Ready!

            | Status | Details |
            |--------|---------|
            | **URL** | ${url} |
            | **Commit** | \`${sha}\` |
            | **Branch** | \`${{ github.head_ref }}\` |`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  # ============================================
  # PRODUCTION DEPLOYMENT - For main branch
  # ============================================
  deploy-production:
    name: Deploy Production
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://alexmayhew.dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: opennext-build
          path: .open-next/

      - name: Verify artifacts
        run: |
          echo "Verifying downloaded artifacts..."
          ls -la .open-next/
          ls -la .open-next/worker.js || echo "worker.js not found"

      - name: Deploy to Cloudflare Workers
        id: deploy
        run: npx opennextjs-cloudflare deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Wait for deployment propagation
        run: sleep 15

      - name: Health Check
        run: |
          echo "Checking health endpoint..."
          response=$(curl -sf https://alexmayhew.dev/api/health || echo '{"status":"error"}')
          echo "Response: $response"

          status=$(echo "$response" | jq -r '.status // "error"')
          if [ "$status" != "ok" ]; then
            echo "Health check failed! Status: $status"
            exit 1
          fi

          echo "Health check passed!"

      - name: Smoke Tests
        run: |
          echo "Running smoke tests..."

          # Test critical pages
          for page in "/" "/services" "/for" "/contact" "/work"; do
            echo "Testing https://alexmayhew.dev$page"
            status=$(curl -s -o /dev/null -w "%{http_code}" "https://alexmayhew.dev$page")
            if [ "$status" != "200" ]; then
              echo "FAILED: $page returned $status"
              exit 1
            fi
            echo "OK: $page"
          done

          echo "All smoke tests passed!"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}'.substring(0, 7);
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Deployment Failed - ${sha}`,
              body: `## Deployment Failure Alert\n\n**Commit:** \`${sha}\`\n**Actor:** @${{ github.actor }}\n**Run:** [View Logs](${runUrl})\n\n### Next Steps\n1. Check the workflow logs\n2. If critical, rollback via Cloudflare Dashboard\n3. Fix the issue and push a new commit`,
              labels: ['deployment', 'bug']
            });
